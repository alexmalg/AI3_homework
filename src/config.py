# ============================================================================
# config.py - Конфигурация приложения и загрузка переменных окружения
# ============================================================================


import os
from dotenv import load_dotenv

load_dotenv()


class Config:
    """
    Класс конфигурации приложения.
    Здесь хранятся все настройки: API ключи, URL, параметры Flask и т.д.
    Начинающим QA-специалистам: этот класс - один источник истины для всех настроек.
    """

    # ========================================================================
    # API КОНФИГУРАЦИЯ
    # ========================================================================

    API_KEY = os.getenv("MENTORPIECE_API_KEY")
    API_ENDPOINT = "https://api.mentorpiece.org/v1/process-ai-request"
    API_AUTH_HEADER = f"Bearer {API_KEY}" if API_KEY else None

    # ========================================================================
    # МОДЕЛИ LLM (указываем какие модели будем использовать)
    # ========================================================================

    TRANSLATION_MODEL = "Qwen/Qwen3-VL-30B-A3B-Instruct"
    EVALUATION_MODEL = "claude-sonnet-4-5-20250929"

    # ========================================================================
    # НАСТРОЙКИ FLASK
    # ========================================================================

    DEBUG = True
    SECRET_KEY = os.getenv("SECRET_KEY", "dev-secret-key-change-in-production")

    # ========================================================================
    # РЕЖИМ ТЕСТИРОВАНИЯ / МОКИ ДЛЯ LLM
    # ========================================================================

    # Флаг включения МОКИРОВАННЫХ ответов LLM.
    #
    # ВАЖНО ДЛЯ QA:
    # - Обычное приложение (продакшн): НЕ устанавливайте эту переменную
    # - Pytest тесты: НЕ используют этот флаг (используют @mock.patch)
    # - Cypress UI-тесты: ДОЛЖНЫ установить ENABLE_LLM_MOCKS=1 перед запуском
    #
    # Почему нужен для Cypress:
    # cy.intercept() перехватывает запросы из БРАУЗЕРА, но Flask делает
    # запросы на СЕРВЕРЕ через Python requests.post(). cy.intercept() их не видит!
    # Поэтому для Cypress мы используем встроенные моки через этот флаг.
    ENABLE_MOCKS = os.getenv("ENABLE_LLM_MOCKS", "0").lower() in ("1", "true", "yes")

    # ========================================================================
    # ПАРАМЕТРЫ ПРИЛОЖЕНИЯ
    # ========================================================================

    MAX_TEXT_LENGTH = 5000

    SUPPORTED_LANGUAGES = {
        "english": "English",
        "french": "French",
        "german": "German",
    }

    # ========================================================================
    # ВАЛИДАЦИЯ КОНФИГУРАЦИИ
    # ========================================================================

    @staticmethod
    def validate():
        """
        Метод для проверки, что все необходимые переменные окружения установлены.
        Вызывается при запуске приложения.

        Начинающим QA-специалистам: если этот метод выбросит исключение,
        значит что-то не в порядке с .env файлом или настройками.
        """
        if not Config.API_KEY and not Config.ENABLE_MOCKS:
            raise ValueError(
                "ОШИБКА: API ключ не найден! "
                "Убедитесь, что переменная окружения MENTORPIECE_API_KEY установлена в .env файле"
            )


# Проверяем конфигурацию при импорте модуля.
try:
    Config.validate()
except ValueError as e:
    print(f"⚠️ ПРЕДУПРЕЖДЕНИЕ: {e}")
